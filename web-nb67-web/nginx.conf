# =============================================================
# Nginx 生产环境配置
# 职责：
#   1. 托管 Vue 3 打包产物（静态 SPA）
#   2. 将 /api/* 转发到 BFF 服务（替代开发环境的 Vite proxy）
#   3. 将 /ws/*  转发到 BFF 服务（WebSocket 升级代理）
# =============================================================

# 工作进程数，auto = CPU 核心数
worker_processes auto;

events {
    # 每个 worker 最大并发连接数
    worker_connections 1024;
}

http {
    # 引入 MIME 类型映射，确保 JS/CSS 资源类型正确
    include       /etc/nginx/mime.types;
    default_type  application/octet-stream;

    # 启用高效文件传输
    sendfile on;

    # 保持连接超时（秒）
    keepalive_timeout 65;

    # 开启 gzip 压缩，减少前端资源传输体积
    gzip on;
    gzip_types text/plain text/css application/javascript application/json
               application/x-javascript text/xml application/xml
               application/xml+rss text/javascript image/svg+xml;
    gzip_min_length 1024;

    # ── BFF 上游服务定义 ──────────────────────────────────────
    # "nb67-bff" 是 Docker Compose 中 BFF 容器的 service name，
    # Docker 内部 DNS 会自动解析此名称，无需写死 IP。
    upstream bff_upstream {
        server nb67-bff:3000;
        keepalive 32; # 保持长连接，提升转发性能
    }

    server {
        # 对外监听端口
        listen 8080;
        server_name _;

        # Vue SPA 静态文件根目录（与 Dockerfile COPY 路径对应）
        root /usr/share/nginx/html;
        index index.html;

        # ── 静态资源缓存策略 ─────────────────────────────────
        # Vite 打包的 JS/CSS 文件名包含 hash，可强缓存一年
        location ~* \.(js|css|png|jpg|jpeg|gif|ico|svg|woff|woff2|ttf|eot)$ {
            expires 1y;
            add_header Cache-Control "public, immutable";
            try_files $uri =404;
        }

        # ── HTTP API 代理 ─────────────────────────────────────
        # 将 /api/* 转发到 BFF，保留完整路径
        location /api/ {
            proxy_pass         http://bff_upstream;
            proxy_http_version 1.1;

            # 传递真实客户端信息给 BFF
            proxy_set_header   Host              $host;
            proxy_set_header   X-Real-IP         $remote_addr;
            proxy_set_header   X-Forwarded-For   $proxy_add_x_forwarded_for;
            proxy_set_header   X-Forwarded-Proto $scheme;

            # 超时配置（BFF 部分查询较慢，适当放宽）
            proxy_connect_timeout 10s;
            proxy_read_timeout    60s;
            proxy_send_timeout    60s;
        }

        # ── WebSocket 代理 ────────────────────────────────────
        # 将 /ws/* 升级为 WebSocket 连接并转发到 BFF
        location /ws/ {
            proxy_pass         http://bff_upstream;
            proxy_http_version 1.1;

            # WebSocket 握手必须的 Upgrade 头
            proxy_set_header   Upgrade    $http_upgrade;
            proxy_set_header   Connection "upgrade";

            proxy_set_header   Host              $host;
            proxy_set_header   X-Real-IP         $remote_addr;

            # WebSocket 长连接，不设超时（0 = 不超时）
            proxy_read_timeout 0;
        }

        # ── Vue SPA 路由支持 ──────────────────────────────────
        # 所有不匹配静态文件的请求，都返回 index.html，
        # 让 Vue Router 的 history 模式在客户端处理路由。
        location / {
            try_files $uri $uri/ /index.html;
        }

        # ── 健康检查端点 ───────────────────────────────────────
        # Docker healthcheck 或负载均衡器探针可使用此端点
        location /health {
            access_log off;
            return 200 "ok\n";
            add_header Content-Type text/plain;
        }
    }
}
