# MACDA-NB67 → Redpanda Connect 重构执行计划（WBS）

## 1. 目标与范围

本计划用于指导旧版 `oldproj/MACDA-NB67` 向新架构重构，范围严格分为三部分：

1. Kafka Connect 开发：二进制解析、标准化、故障告警、故障预测、数据存储。
2. 展示页数据 API 开发：通用/可配置化 SQL API + WebSocket 数据服务。
3. 前端页面适配与优化：先适配、后优化（对应 `web-nb67.250513`）。

## 2. 总体架构（目标态）

```text
Binary Frame
  -> raw topic
  -> Connect 解析/标准化
  -> 标准化 topic
      -> 告警规则流（全量） -> alert_event / notify
      -> 预测流（窗口聚合） -> predict_event
      -> 存储流（采样/双轨） -> TimescaleDB
  -> Query Gateway (config-driven REST + WebSocket)
  -> web-nb67 前端
```

## 3. 分阶段与按周计划（12周）

## 阶段 A：协议对齐与数据底座（第1-3周）

### 第1周：协议冻结与字段契约
- 完成 NB67 协议冻结（含新增字段：`DmpEXU_pos`、`Start_Station`、`Terminal_Station`、`Cur_Station`、`Next_Station`）。
- 输出统一字段字典：字段名、单位、缩放系数、空值语义、枚举语义。
- 定义 Topic 规划与命名规范。

交付物：
- `docs/requirements` 字段契约补充说明。
- 统一字段字典（CSV/Markdown）。
- Topic 命名与保留策略文档。

### 第2周：解析插件与标准化映射
- 完成 Connect 自定义解析器（建议 Go + Kaitai）。
- 建立标准化映射（单位换算、异常值标记、质量标记）。
- 输出解析一致性测试（样本帧 -> JSON 结果比对）。

交付物：
- 可运行解析插件。
- 映射配置文件（Bloblang/processor config）。
- 解析回归测试报告。

### 第3周：TimescaleDB 基础模型
- 创建原始表、事件表、维表、索引。
- 建立分区（hypertable）、压缩策略、保留策略。
- 初步完成写入链路（Connect -> DB）。

交付物：
- DDL 脚本（schema/init/migration）。
- 入库性能基线报告（吞吐、延迟、错误率）。

---

## 阶段 B：核心业务能力（第4-8周）

### 第4周：实时告警流（全量）
- 实现规则引擎（阈值、组合条件、去抖、抑制、恢复）。
- 事件输出到 `alert_event`，预留外部通知接口。

交付物：
- 告警规则配置。
- 告警事件模型与示例。
- 告警准确性抽样评估。

### 第5周：预测流（先规则后模型）
- 先迁移旧系统规则预测（保证可回归）。
- 抽象模型接口（HTTP/gRPC），实现可插拔预测。

交付物：
- 预测作业与调度配置。
- `predict_event` 表与查询示例。
- 旧系统对齐报告（一致率）。

### 第6周：双轨存储策略
- 落地“全量告警轨 + 采样存储轨”。
- 实现重放、死信、失败补偿。

交付物：
- 双轨 Connect 配置。
- 数据丢失与重放演练报告。

### 第7周：Query Gateway（REST）
- 实现配置驱动 API：通过 SQL 模板 + 参数生成查询接口。
- 提供分页、时间粒度、过滤、排序、缓存、限流。

交付物：
- Query Gateway 服务（MVP）。
- API 配置示例（历史报警/历史数据/趋势）。
- OpenAPI 文档。

### 第8周：Query Gateway（WebSocket）
- 增加订阅能力（实时告警、实时状态、秒级趋势）。
- 提供统一消息协议（事件类型、时间戳、版本、payload）。

交付物：
- WebSocket 订阅服务。
- 前端联调 Demo。

---

## 阶段 C：前端适配与优化（第9-12周）

### 第9周：先适配（功能可用）
- `web-nb67.250513` 对接新 API。
- 实现关键页面可用：历史报警、历史数据、列车/车厢联动、趋势图。

交付物：
- 前端适配分支与联调记录。
- 关键页面可用性验收。

### 第10周：性能优化（查询与渲染）
- 后端：慢查询治理、索引补齐、缓存命中优化。
- 前端：虚拟列表、图表抽样、按需加载。

交付物：
- 性能对比报告（优化前后）。
- 压测脚本与结果。

### 第11周：稳定性与灰度
- 灰度上线：新旧链路并行校验。
- 错误预算、回滚方案、告警阈值确定。

交付物：
- 灰度方案与回滚手册。
- 生产监控面板。

### 第12周：上线与验收
- 正式切流，关闭旧链路关键写路径。
- 完成文档归档、运维交接、培训。

交付物：
- 上线验收报告。
- 运维手册、故障手册、值班手册。

## 4. 三大模块详细 WBS

## 4.1 Kafka Connect 开发
- 协议解析：NB67 二进制解析插件、版本兼容、字段校验。
- 标准化：命名、单位、缩放、时间统一（设备时间/处理时间）。
- 告警：规则中心、告警状态机、抑制与恢复、事件化输出。
- 预测：窗口聚合、规则预测、模型接口。
- 存储：批量写入、事务边界、幂等键、重试与死信。
- 可观测性：处理延迟、解析失败率、队列积压、写库失败率。

## 4.2 展示页数据 API（通用/可配置）
- 配置模型：
  - dataset
  - sql_template
  - params_schema
  - default_filters
  - time_grain
  - cache_ttl
  - auth_scope
- API 能力：
  - REST：明细、聚合、导出任务。
  - WebSocket：告警流、状态流、趋势流。
- 安全治理：SQL 白名单、参数校验、限流、审计、超时熔断。

## 4.3 前端页面适配与优化
- 适配优先：接口替换、字段映射、交互打通。
- 优化其次：表格与图表性能、查询约束、加载体验。
- 验收指标：首屏时延、操作响应、长时间窗查询稳定性。

## 5. 后端数据库设计（TimescaleDB）

## 5.1 分层模型
- `fact_hvac_raw`：标准化原始数据（时序主表，hypertable）。
- `event_alert`：告警事件（开始/恢复/等级/来源规则）。
- `event_predict`：预测事件（风险分值、标签、窗口）。
- `dim_train`、`dim_carriage`、`dim_device`：维表。
- `agg_hvac_1m`、`agg_hvac_1h`、`agg_hvac_1d`：连续聚合视图。

## 5.2 关键设计原则
- 主键建议：`device_id + event_time + metric_group`（防重复写）。
- 时间统一：保留 `device_time` + `ingest_time` + `process_time`。
- 索引：`(device_id, event_time desc)`、`(train_no, carriage_no, event_time desc)`。
- 保留策略：原始 365 天，聚合长期；告警与预测按业务要求保留。
- 压缩策略：7 天后压缩 chunk，降低存储与 IO。

## 5.3 查询能力面向前端
- 历史报警：按时间窗、列车、车厢、机组、等级过滤。
- 历史数据：按指标组分页查询，支持导出任务。
- 秒级趋势：短窗口高频查询，必要时走缓存/预聚合。

## 6. 验收指标（必须量化）
- 解析正确率 >= 99.99%。
- 端到端延迟 P99 <= 5s（告警链路）。
- 数据写入成功率 >= 99.99%。
- 前端关键页面首屏 <= 3s（常用时间窗）。
- 大时间窗查询失败率 <= 0.1%。

## 7. 风险与应对

### R1 协议变更导致解析错位
- 应对：协议版本号 + 字段映射版本；样本回归测试门禁。

### R2 预测规则迁移偏差
- 应对：新旧并行跑分，对齐阈值，分阶段切流。

### R3 大时间窗查询拖垮数据库
- 应对：时间窗限制、异步导出、预聚合、缓存、慢查询熔断。

### R4 WebSocket 订阅风暴
- 应对：连接限流、订阅粒度控制、热点 topic 分片。

### R5 告警噪声过大
- 应对：抑制策略、去抖、恢复确认、黑白名单。

## 8. 任务拆分建议（用于创建 issue）
- EPIC-1：Connect 解析与标准化
- EPIC-2：告警与预测事件流
- EPIC-3：TimescaleDB 建模与优化
- EPIC-4：Query Gateway（REST + WS）
- EPIC-5：前端适配（先适配）
- EPIC-6：前端性能与体验优化
- EPIC-7：灰度、上线与运维交接

---

本计划为当前版本（2026-02-19），后续按每周回顾更新。
