input:
  kafka:
    addresses:
      - redpanda-1:9092
      - redpanda-2:9092
      - redpanda-3:9092
    topics:
      - signal.parsed.v1
    consumer_group: macda-event-v1
    start_from_oldest: false
    commit_period: 1s

pipeline:
  threads: 2
  processors:
    - mapping: |
        root.event_meta = {
          "schema_version": "nb67.event.v1",
          "line_id": this.line_id,
          "train_id": this.train_id,
          "carriage_id": this.carriage_id,
          "device_id": this.device_id,
          "event_time_text": this.event_time_text,
          "ingest_time": this.ingest_time,
          "process_time": now()
        }

        root.predict_hits = []
        root.alarm_hits = []

        # ================================================================
        # 预测规则（移植自原项目 oldproj/MACDA-NB67/utils/tsutil.py）
        # 原项目对时间窗口均值做规则判断，此处对瞬时值做等效判断
        # 缩放：所有模拟量字段 raw = 物理值 × 10（Python div10list）
        #        AQ CO2/PM/TVOC 无缩放（不在 div10list）
        # ================================================================

        # 1. 冷媒泄漏预警 (ref_leak) —— 4路
        #    制冷/热泵模式(2/3): 压缩机频率>30Hz 且 吸气压力<2MPa
        #    通风模式(1):        高压压力<5MPa
        if (this.raw.WmodeU1 == 2 || this.raw.WmodeU1 == 3) && this.raw.FCpU11 > 300 && this.raw.SuckpU11 < 20 {
          root.predict_hits = root.predict_hits.append({"code":"ref_leak_u11","severity":2})
        }
        if this.raw.WmodeU1 == 1 && this.raw.HighpressU11 < 50 {
          root.predict_hits = root.predict_hits.append({"code":"ref_leak_u11","severity":2})
        }
        if (this.raw.WmodeU1 == 2 || this.raw.WmodeU1 == 3) && this.raw.FCpU12 > 300 && this.raw.SuckpU12 < 20 {
          root.predict_hits = root.predict_hits.append({"code":"ref_leak_u12","severity":2})
        }
        if this.raw.WmodeU1 == 1 && this.raw.HighpressU12 < 50 {
          root.predict_hits = root.predict_hits.append({"code":"ref_leak_u12","severity":2})
        }
        if (this.raw.WmodeU2 == 2 || this.raw.WmodeU2 == 3) && this.raw.FCpU21 > 300 && this.raw.SuckpU21 < 20 {
          root.predict_hits = root.predict_hits.append({"code":"ref_leak_u21","severity":2})
        }
        if this.raw.WmodeU2 == 1 && this.raw.HighpressU21 < 50 {
          root.predict_hits = root.predict_hits.append({"code":"ref_leak_u21","severity":2})
        }
        if (this.raw.WmodeU2 == 2 || this.raw.WmodeU2 == 3) && this.raw.FCpU22 > 300 && this.raw.SuckpU22 < 20 {
          root.predict_hits = root.predict_hits.append({"code":"ref_leak_u22","severity":2})
        }
        if this.raw.WmodeU2 == 1 && this.raw.HighpressU22 < 50 {
          root.predict_hits = root.predict_hits.append({"code":"ref_leak_u22","severity":2})
        }

        # 2. 制冷系统预警 (f_cp) —— 2路
        #    两台压缩机同频但电流差>2A，或过热度异常(>20°C 或 <-8°C)
        let cp_u1_diff = this.raw.ICpU11 - this.raw.ICpU12
        if this.raw.FCpU11 == this.raw.FCpU12 && ($cp_u1_diff > 20 || $cp_u1_diff < -20) {
          root.predict_hits = root.predict_hits.append({"code":"f_cp_u1","severity":2})
        }
        if this.raw.SpU11 > 200 || this.raw.SpU11 < -80 || this.raw.SpU12 > 200 || this.raw.SpU12 < -80 {
          root.predict_hits = root.predict_hits.append({"code":"f_cp_u1","severity":2})
        }
        let cp_u2_diff = this.raw.ICpU21 - this.raw.ICpU22
        if this.raw.FCpU21 == this.raw.FCpU22 && ($cp_u2_diff > 20 || $cp_u2_diff < -20) {
          root.predict_hits = root.predict_hits.append({"code":"f_cp_u2","severity":2})
        }
        if this.raw.SpU21 > 200 || this.raw.SpU21 < -80 || this.raw.SpU22 > 200 || this.raw.SpU22 < -80 {
          root.predict_hits = root.predict_hits.append({"code":"f_cp_u2","severity":2})
        }

        # 3. 新风/回风温度传感器预警 (f_fas / f_ras)
        #    U1 与 U2 温差 > 8°C (raw > 80)
        let fas_diff = this.raw.FasU1 - this.raw.FasU2
        if $fas_diff > 80 || $fas_diff < -80 {
          root.predict_hits = root.predict_hits.append({"code":"f_fas","severity":2})
        }
        let ras_diff = this.raw.RasU1 - this.raw.RasU2
        if $ras_diff > 80 || $ras_diff < -80 {
          root.predict_hits = root.predict_hits.append({"code":"f_ras","severity":2})
        }

        # 4. 车厢温度超温预警 (cabin_overtemp)
        if this.raw.BfltTempover == true {
          root.predict_hits = root.predict_hits.append({"code":"cabin_overtemp","severity":1})
        }

        # 5. 滤网脏堵预警 (f_presdiff) —— 2路
        #    通风机运行且压差 > 300Pa (raw > 3000)
        if this.raw.CfbkEfU11 == true && this.raw.PresdiffU1 > 3000 {
          root.predict_hits = root.predict_hits.append({"code":"f_presdiff_u1","severity":2})
        }
        if this.raw.CfbkEfU21 == true && this.raw.PresdiffU2 > 3000 {
          root.predict_hits = root.predict_hits.append({"code":"f_presdiff_u2","severity":2})
        }

        # 6. 通风机电流预警 (f_ef) —— 4路
        #    运行时电流 > 2A (raw > 20)
        if this.raw.CfbkEfU11 == true && this.raw.IEfU11 > 20 {
          root.predict_hits = root.predict_hits.append({"code":"f_ef_u11","severity":2})
        }
        if this.raw.CfbkEfU11 == true && this.raw.IEfU12 > 20 {
          root.predict_hits = root.predict_hits.append({"code":"f_ef_u12","severity":2})
        }
        if this.raw.CfbkEfU21 == true && this.raw.IEfU21 > 20 {
          root.predict_hits = root.predict_hits.append({"code":"f_ef_u21","severity":2})
        }
        if this.raw.CfbkEfU21 == true && this.raw.IEfU22 > 20 {
          root.predict_hits = root.predict_hits.append({"code":"f_ef_u22","severity":2})
        }

        # 7. 冷凝风机电流预警 (f_cf) —— 4路
        #    运行时电流 > 2.9A (raw > 29)
        if this.raw.CfbkCfU11 == true && this.raw.ICfU11 > 29 {
          root.predict_hits = root.predict_hits.append({"code":"f_cf_u11","severity":2})
        }
        if this.raw.CfbkCfU11 == true && this.raw.ICfU12 > 29 {
          root.predict_hits = root.predict_hits.append({"code":"f_cf_u12","severity":2})
        }
        if this.raw.CfbkCfU21 == true && this.raw.ICfU21 > 29 {
          root.predict_hits = root.predict_hits.append({"code":"f_cf_u21","severity":2})
        }
        if this.raw.CfbkCfU21 == true && this.raw.ICfU22 > 29 {
          root.predict_hits = root.predict_hits.append({"code":"f_cf_u22","severity":2})
        }

        # 8. 废排风机电流预警 (f_exufan)
        #    运行时电流 > 4A (raw > 40)
        if this.raw.CfbkExufan == true && this.raw.IExufan > 40 {
          root.predict_hits = root.predict_hits.append({"code":"f_exufan","severity":2})
        }

        # 9. 压缩机电流过大预警 (f_fas_u) —— 4路
        #    新风量 < 35% (raw < 350) 时压缩机电流 > 18A (raw > 180)
        #    注：原项目命名 f_fas_u11/u21 → U1单元, f_fas_u12/u22 → U2单元
        if this.raw.FasU1 < 350 && this.raw.ICpU11 > 180 {
          root.predict_hits = root.predict_hits.append({"code":"f_fas_u11","severity":2})
        }
        if this.raw.FasU1 < 350 && this.raw.ICpU12 > 180 {
          root.predict_hits = root.predict_hits.append({"code":"f_fas_u21","severity":2})
        }
        if this.raw.FasU2 < 350 && this.raw.ICpU21 > 180 {
          root.predict_hits = root.predict_hits.append({"code":"f_fas_u12","severity":2})
        }
        if this.raw.FasU2 < 350 && this.raw.ICpU22 > 180 {
          root.predict_hits = root.predict_hits.append({"code":"f_fas_u22","severity":2})
        }

        # 10. 空气质量监测预警 (f_aq) —— 2路
        #     通风机运行且 CO2>1200ppm 或 PM2.5>75 或 PM10>150 或 TVOC>600
        #     (AQ字段不在div10list，直接用原始阈值)
        if this.raw.CfbkEfU11 == true && (this.raw.AqCo2U1 > 1200 || this.raw.AqPm25U1 > 75 || this.raw.AqPm10U1 > 150 || this.raw.AqTvocU1 > 600) {
          root.predict_hits = root.predict_hits.append({"code":"f_aq_u1","severity":2})
        }
        if this.raw.CfbkEfU21 == true && (this.raw.AqCo2U2 > 1200 || this.raw.AqPm25U2 > 75 || this.raw.AqPm10U2 > 150 || this.raw.AqTvocU2 > 600) {
          root.predict_hits = root.predict_hits.append({"code":"f_aq_u2","severity":2})
        }

        # 原生故障位告警
        if this.raw.BlpfltCompU11 == true {
          root.alarm_hits = root.alarm_hits.append({"code":"blpflt_comp_u11", "level":2})
        }

        if this.raw.BscfltCompU11 == true {
          root.alarm_hits = root.alarm_hits.append({"code":"bscflt_comp_u11", "level":2})
        }

        if this.raw.BfltTempover == true {
          root.alarm_hits = root.alarm_hits.append({"code":"bflt_tempover", "level":1})
        }

        root.predict_event = {
          "event_meta": root.event_meta,
          "hits": root.predict_hits,
          "source": "connect-rule-lite"
        }

        root.alarm_event = {
          "event_meta": root.event_meta,
          "hits": root.alarm_hits,
          "source": "raw-fault-bit"
        }

output:
  broker:
    pattern: fan_out
    outputs:
      - kafka:
          addresses:
            - redpanda-1:9092
            - redpanda-2:9092
            - redpanda-3:9092
          topic: signal.event.predict.v1
          key: ${! this.event_meta.device_id }
          partitioner: round_robin
          max_in_flight: 64
          compression: snappy
      - kafka:
          addresses:
            - redpanda-1:9092
            - redpanda-2:9092
            - redpanda-3:9092
          topic: signal.event.alarm.v1
          key: ${! this.event_meta.device_id }
          partitioner: round_robin
          max_in_flight: 64
          compression: snappy

logger:
  level: INFO
  format: json

metrics:
  prometheus:
    add_process_metrics: true
    add_go_metrics: true
